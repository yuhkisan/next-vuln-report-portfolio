# 依存パッケージ脆弱性スキャナ 基本設計書

> 注意: 本文書は初期構想です。現行仕様は `docs/BEHAVIOR_SPEC.md` / `docs/USER_MANUAL.md` / `PORTFOLIO_A_PLAN.md` を参照してください。
> 以降はアーカイブとして扱い、通常は更新しません。

## 1. システム概要

### 1.1 システム名（仮称）

Dependency Vulnerability Scanner

### 1.2 システム概要

本システムは、フロントエンドプロジェクトの `package.json` をアップロードし、含まれる npm 依存パッケージに既知の脆弱性が存在するかを解析・可視化する Web アプリケーションである。

外部の脆弱性データベース（OSV.dev）から脆弱性情報を取得し、

- 脆弱性の一覧表示
- Severity 別のフィルタ
- SSVC 風の優先度付け・ソート
- プロジェクト単位での結果保存（ブラウザ内）

を行う。Next.js + React + TypeScript + MUI を利用し、フロントエンドエンジニアとしてのスキルを示すポートフォリオを目的とする。

---

## 2. 目的

1. SES 現場での脆弱性管理アプリ開発経験をベースに、フロントエンド〜簡易バックエンドまでを一通り設計・実装できることを示す。
2. React / Next.js / TypeScript / MUI / Storybook / テストの組み合わせを、実務的なテーマでポートフォリオとして提示する。
3. 単なる「リスト表示」ではなく、SSVC 風の優先度付けやプロジェクト管理など、業務アプリとしての構成を持たせる。

---

## 3. 前提・範囲・非対象

### 3.1 前提

- 対象パッケージマネージャは npm のみ。
- 入力ファイルは基本的に `package.json` 1 ファイルとする。
- バージョン指定は `^1.2.3` 等の範囲指定を簡略化し、代表値（例: `1.2.3`）として扱う。
- データ永続化はブラウザの `localStorage` を用い、サーバーサイドのデータベースは使用しない。
- 脆弱性情報は OSV.dev のみを利用し、他の脆弱性 DB（NVD など）は対象外とする。

### 3.2 非対象

- 商用サービスとしての本番レベルのセキュリティ対策（WAF、CSRF 対策の細部、権限管理など）。
- npm 以外のエコシステム（Maven, PyPI 等）。
- `package-lock.json` / `yarn.lock` などの lock ファイル解析（将来拡張として扱う）。

---

## 4. システム構成

### 4.1 アーキテクチャ概要

- フロントエンド

  - Next.js（App Router）
  - React
  - TypeScript
  - MUI

- バックエンド（簡易）

  - Next.js の API Route
  - OSV.dev への HTTP リクエスト実行

- データ保存

  - ブラウザの `localStorage`
  - サーバーサイド DB は利用しない

### 4.2 画面レイアウト

- 左サイドバー

  - アプリロゴ・タイトル
  - 「新しいプロジェクト」ボタン
  - 「プロジェクトを検索」入力
  - プロジェクト一覧（ログイン／デモユーザー時）

- 上部バー

  - 現在のプロジェクト名またはアプリ名
  - SSVC 設定アイコン
  - ログイン／ユーザーアイコン

- メインコンテンツ

  - 初期状態：`package.json` アップロードカード
  - 解析後：サマリーカード + フィルタバー + 脆弱性一覧テーブル

レイアウトは ChatGPT 風の構成を参考にしつつ、配色・文言・アイコン・コンポーネント構成は本システム向けに独自に設計する。

---

## 5. ユーザー種別と権限

### 5.1 ユーザー種別

- ゲストユーザー

  - ログインせずに利用
  - 解析は可能だが、ページリロード時に全データが消える

- デモユーザー

  - 「デモとしてログイン」ボタン押下でログイン状態になる
  - ブラウザの `localStorage` にプロジェクト・設定が保存され、リロード後も復元される

### 5.2 権限差分

- 共通（ゲスト／デモ）

  - `package.json` のアップロード
  - 脆弱性解析
  - フィルタ・ソート
  - SSVC 設定（ゲストはメモリ上のみ）

- デモユーザーのみ

  - プロジェクトとして結果を保存
  - プロジェクト一覧の閲覧・選択
  - SSVC 設定の永続化

---

## 6. 機能要件（概要）

### 6.1 ファイルアップロード

- `package.json` をドラッグ＆ドロップ、またはファイル選択でアップロードできる。
- JSON 以外のファイルが選択された場合、エラーメッセージを表示する。
- ファイルサイズ上限（例：5MB）を超える場合、エラーメッセージを表示する。

### 6.2 依存パッケージ解析

- `dependencies` および `devDependencies` からパッケージ名とバージョン指定文字列を抽出する。
- セマンティックバージョンの範囲指定は簡易的に代表バージョンへ変換する。
- `runtime` / `dev` の種別情報を保持する。

### 6.3 脆弱性情報取得

- Next.js API Route (`/api/scan`) から OSV.dev の `querybatch` API を呼び出す。
- npm エコシステム・パッケージ名・バージョンを指定して脆弱性情報を取得する。
- 各脆弱性について、ID・要約・Severity・影響バージョン・修正バージョン・参考 URL などを内部構造に格納する。
- 一部パッケージでの取得失敗時も、他のパッケージの解析は継続する。

### 6.4 脆弱性一覧表示

- 解析結果として、以下を表示する：

  - サマリーカード

    - 依存パッケージ数
    - 脆弱性総数
    - 高 Severity 脆弱性件数（HIGH 以上）

  - 脆弱性一覧テーブル

    - パッケージ名
    - バージョン（`package.json` の指定）
    - 脆弱性 ID
    - Severity（色付きチップ）
    - SSVC カテゴリ（設定済みの場合）
    - 詳細表示アクション

### 6.5 フィルタ・ソート

- Severity フィルタ（ALL / LOW / MEDIUM / HIGH / CRITICAL）。
- パッケージ名・脆弱性 ID でのテキスト検索。
- ソート条件

  - パッケージ名
  - Severity
  - SSVC 優先度

- SSVC 設定が存在しない状態で SSVC ソートを選択した場合は、設定ダイアログを表示し、ソートは行わない。

### 6.6 SSVC 風優先度設定

- SSVC の考え方を簡略化した設定項目を提供する：

  - Severity ごとの重み（CRITICAL / HIGH / MEDIUM / LOW）
  - devDependencies の減点値
  - 悪用中フラグの加点値

- 設定に基づき、各脆弱性にスコアを計算し、カテゴリ（IMMEDIATE / SOON / LATER 等）を付与する。
- デモユーザー時は設定を `localStorage` に保存する。ゲスト時はメモリ上のみ保持する。

### 6.7 プロジェクト管理

- デモユーザーは解析結果を「プロジェクト」として保存できる。
- 保存内容（例）：

  - プロジェクト ID・名称
  - `package.json` 内容
  - 解析結果サマリー
  - 最終スキャン日時
  - SSVC 設定

- プロジェクト一覧をサイドバーに表示し、選択で復元できる。
- 「再スキャン」操作により、保存済み依存情報から最新の脆弱性情報を再取得できる。

---

## 7. 非機能要件（概要）

### 7.1 パフォーマンス

- 依存パッケージ数 100〜200 件程度の `package.json` に対して、通常数秒〜十数秒程度で解析結果を表示することを目標とする。
- OSV API への問い合わせはタイムアウトを設定し、上限は 30 秒程度とする。
- タイムアウト時はユーザーにエラーメッセージを表示し、再試行の導線を用意する。

### 7.2 セキュリティ

- アップロードされた `package.json` の内容はブラウザメモリおよび `localStorage` のみに保存し、サーバー側 DB には保存しない。
- 外部 API へ送信する情報はパッケージ名・バージョン・エコシステムに限定し、ユーザー名やプロジェクト名などの識別情報は含めない。
- 本システムはポートフォリオ用途であり、本番サービスレベルの包括的なセキュリティ対策はスコープ外とすることを明記する。

### 7.3 信頼性

- OSV API への通信エラー時に再試行または部分的な結果表示ができるようにする。
- 予期しないエラー発生時は、ユーザー向けに汎用エラーメッセージを表示し、開発者向けにはコンソールログで原因調査可能とする。

### 7.4 UI/UX

- MUI を用いた一貫性のある UI コンポーネントを採用する。
- PC での利用をメインとしつつ、タブレット・スマホでも最低限利用可能なレスポンシブレイアウトとする。

  - モバイル時はサイドバーを Drawer 表示に切り替え、テーブルは横スクロール対応とする。

- アップロード前／解析中／解析後／エラー時の状態が視覚的に区別できるようにする。

---

## 8. 外部インターフェース（概要）

### 8.1 OSV.dev API

- 利用 API：`/v1/querybatch`
- 入力：npm エコシステム、パッケージ名、バージョンの一覧
- 出力：脆弱性 ID、概要、影響範囲、修正バージョンなど
- 詳細なパラメータ・レスポンス構造は詳細設計書にて定義する。

### 8.2 内部 API（Next.js API Route）

- `/api/scan`（POST）

  - 入力：`package.json` 内容
  - 出力：依存情報および脆弱性一覧を含む `ScanResult`
  - 詳細な I/F は詳細設計書で定義する。

---

## 9. 今後詳細設計で詰める項目

- 画面ごとの項目一覧／メッセージ文言／入力バリデーションルール
- `/api/scan` など API の Request/Response JSON スキーマ詳細
- SSVC 風スコア計算の具体式とカテゴリ境界値
- `localStorage` に保存するデータ構造（キー名・JSON 構造）
- 状態管理の実装方針（Context の構成、コンポーネント間のデータフロー）
- Storybook・テストの対象コンポーネントとテストケースの範囲

本基本設計書を元に実装を進め、実装内容が固まった段階で詳細設計書を作成・更新する。
