# ポートフォリオ A 方針ドキュメント

> **目的**: ユーザーが `package-lock.json` をアップロードすると、依存（name/version）を抽出し、脆弱性レポート UI を表示するデモアプリケーション

---

## 1. このポートフォリオで示す価値（React/FE 観点）

- **"脆弱性一覧を受け取るだけ"ではなく、判断と行動につなげる UI**

  - サマリーで全体像を把握 → フィルタで絞り込み → 詳細で意思決定
  - 「何をすべきか」を示す推奨アクションのガイド

- **非同期フロー（アップロード → 解析 → 結果/失敗）と状態管理**

  - アップロード進行状態・解析中・完了・エラーを明確に区別
  - TanStack Query（または useReducer）で複雑な状態遷移を整理

- **情報設計（サマリー、フィルタ、グルーピング、詳細ドロワー）**

  - Critical/High/Medium/Low/Info の件数サマリー
  - severity / prod・dev 依存でのフィルタリング
  - 原因の直依存（root dependency）でグルーピング表示
  - 行クリックで詳細ドロワー（dependencyPath、参照リンク、推奨対応）

- **型安全（API 型 →UI 用 ViewModel）とテスト最小セット**
  - API レスポンス型と UI 表示用 ViewModel を分離
  - 集計・グルーピングロジックのユニットテスト

---

## 2. スコープ（やること）

| カテゴリ       | 内容                                                                                 |
| -------------- | ------------------------------------------------------------------------------------ |
| **対象**       | npm + `package-lock.json`（lockfileVersion 2/3）に限定                               |
| **API**        | Next の Route Handler でアップロードを受け取り（`POST /api/scans`）                  |
| **依存抽出**   | `package-lock.json` の `packages` から解決済み依存（name/version）を抽出（実装する） |
| **脆弱性照合** | モック/fixture（入力依存で結果が変わる）                                             |
| **画面**       | アップロード / スキャン中 / 結果 / エラー / 0 件（空状態）                           |

### 結果表示の必須要素

- **Summary**: Critical / High / Medium / Low 件数の可視化
- **フィルタ**: severity、prod/dev（dependencies vs devDependencies）
- **グルーピング**: 原因の直依存（root dependency）でグループ化
- **詳細ドロワー**: 行クリックで表示
  - dependencyPath（脆弱パッケージまでの経路）
  - 参照リンク（CVE、NPM Advisory 等）
  - 推奨アクション（更新 / overrides / 受容）のガイド

---

## 3. 非スコープ（やらないこと）

| 項目                                   | 理由                                         |
| -------------------------------------- | -------------------------------------------- |
| npm 以外（yarn/pnpm、他言語）          | 完成度優先、npm lockfile v2/3 に集中         |
| lockfileVersion 1 対応                 | レガシー形式は除外                           |
| 厳密な依存グラフ復元（完全な経路解析） | MVP では簡易解析で対応                       |
| 自動修正（npm audit fix 相当）         | UI での判断支援に集中                        |
| 認証/DB/履歴/組織機能                  | 余力があれば「結果のみ保存」を拡張として検討 |

---

## 4. アーキテクチャ概要（Next らしさ）

### ルーティング（App Router）

```
app/
├── page.tsx              # アップロード画面
├── scans/
│   └── [id]/
│       └── page.tsx      # 結果表示画面
├── api/
│   └── scans/
│       └── route.ts      # POST /api/scans（アップロード受領）
├── components/           # 共通コンポーネント
├── lib/                  # ユーティリティ・型定義
└── types/                # 型定義
```

### API 設計

| エンドポイント       | 用途                                                  |
| -------------------- | ----------------------------------------------------- |
| `POST /api/scans`    | lockfile アップロード → 解析 → 結果返却（MVP は同期） |
| `GET /api/scans/:id` | （拡張）ポーリング用、非同期解析の場合                |

### フロントエンド状態管理

- **TanStack Query を使う場合**
  - `useMutation`: ファイルアップロード
  - `useQuery`: 結果取得（非同期の場合は`refetchInterval`でポーリング）
- **ViewModel 変換**: API レスポンス → 集計・グルーピング・検索用に変換

### データ変換層

```
APIレスポンス (VulnerabilityReport)
    ↓
ViewModel (
  summary: { critical: number, high: number, ... },
  groupedByRootDep: Map<string, Vulnerability[]>,
  filterableList: Vulnerability[]
)
    ↓
UIコンポーネント
```

---

## 5. データの扱い（プライバシー/保存方針）

| 方針               | 説明                                                                     |
| ------------------ | ------------------------------------------------------------------------ |
| **ファイル非保存** | アップロードされた lockfile はサーバーに保存しない（受領 → 解析 → 破棄） |
| **結果も非保存**   | リロードで結果は消える（プライバシー保護）                               |
| **拡張案**         | 結果のみ localStorage で保持（ユーザー体験改善として検討）               |

---

## 6. 開発フロー（コマンド例）

### 既存スクリプト（package.json）

```bash
# 開発サーバー起動
npm run dev

# 本番ビルド
npm run build

# 本番サーバー起動
npm start

# Lint実行
npm run lint
```

### テスト（追加予定）

```bash
# ユニットテスト実行（追加予定）
npm test

# E2Eテスト実行（追加予定）
npm run test:e2e
```

### モック/fixture の管理

| ファイル                | 用途                                              |
| ----------------------- | ------------------------------------------------- |
| `app/lib/fixtures/`     | モック脆弱性データ（追加予定）                    |
| `app/lib/mockVulnDb.ts` | 入力依存でフィルタリングされる擬似 DB（追加予定） |

> **更新手順**: 新しい脆弱性パターンを追加する場合は、fixture ファイルにエントリを追加

---

## 7. 面接で話すポイント（想定 QA）

### Q: なぜ npm/lockfile v2/3 に絞ったか？

> 完成度と精度のバランス。lockfile v2/3 はモダンな npm プロジェクトの標準であり、`packages`フィールドから依存を正確に抽出できる。v1 や yarn/pnpm まで対応すると実装が複雑化し、UI の品質に集中できなくなる。

### Q: なぜ脆弱性照合をモックにしたか？

> 責務分離と FE 評価点への集中。脆弱性 DB の精度はバックエンド/インフラの領域。このポートフォリオは React/フロントエンドスキルを示すことが目的なので、UI/UX とデータ変換ロジックに注力した。

### Q: npm audit との差別化は？

> npm audit は CLI 中心で「出力して終わり」。本アプリは**共有・判断・対応 UX**を重視：
>
> - チームで共有しやすい Web UI
> - 優先度判断のためのサマリーとフィルタ
> - 「何をすべきか」を示す推奨アクションガイド

### Q: 推移依存（transitive dependency）の対応方針は？

> 1. まず直依存の更新で解決を試みる
> 2. 直依存で解決不可なら`overrides`（npm 8.3+）を検討
> 3. 影響が軽微なら受容（Accept Risk）を判断

---

## 8. 今後の拡張（時間があれば）

| 拡張                       | 説明                                                       |
| -------------------------- | ---------------------------------------------------------- |
| **OSV 等の実データ参照**   | モックを Provider 差し替えで実 API に接続                  |
| **結果共有 URL**           | 結果のみ TTL 付きで保存、URL で共有可能に                  |
| **大量件数の仮想化**       | react-virtualize で 1000 件超の脆弱性も高速表示            |
| **URL でフィルタ状態共有** | クエリパラメータでフィルタ条件を永続化                     |
| **E2E テスト追加**         | Playwright 等でアップロード → 結果表示の一連フローをテスト |
| **追加 lockfile 形式**     | yarn.lock、pnpm-lock.yaml 対応（将来）                     |

---

## 関連ドキュメント

- [README.md](./README.md) - プロジェクト概要
- [要件定義書.md](./要件定義書.md) - 詳細要件
- [基本設計書.md](./基本設計書.md) - 設計詳細
